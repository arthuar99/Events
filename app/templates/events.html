{% extends "base.html" %}

{% block title %}Available Events{% endblock %}

{% block content %}
<div class="text-center mb-3">
    <h1>Available Events</h1>
    <p>Discover upcoming events and book your seat</p>
</div>

<div class="grid grid-3" id="eventsContainer">
    <!-- Events will be loaded here -->
</div>

<!-- Seat Picker Modal -->
<div id="seatModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('seatModal')">&times;</span>
        <h2 id="eventTitle">Select Seat</h2>

        <div class="seat-grid" id="seatGrid">
            <!-- Seats will be generated here -->
        </div>

        <div class="text-center mt-3">
            <p>Selected Seat: <span id="selectedSeat">-</span></p>
            <button class="btn" onclick="confirmBooking()" id="confirmBtn" disabled>Confirm Booking</button>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div id="qrModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('qrModal')">&times;</span>
        <h2>Booking Successful!</h2>

        <div class="text-center">
            <div id="qrCode"></div>
            <p class="mt-2">Seat Number: <span id="bookedSeat"></span></p>
            <p>Event: <span id="bookedEvent"></span></p>

            <div class="mt-3">
                <button class="btn" onclick="downloadTicket()">Download Ticket</button>
                <button class="btn btn-secondary" onclick="sendEmail()">Send to Email</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentEvent = null;
    let selectedSeat = null;

    // Load events on page load
    document.addEventListener('DOMContentLoaded', loadEvents);

    async function loadEvents() {
        try {
            const response = await fetch('/api/events');
            if (response.ok) {
                const events = await response.json();
                displayEvents(events);
            } else {
                showAlert('Failed to load events', 'error');
            }
        } catch (error) {
            showAlert('Connection error occurred', 'error');
        }
    }

    function displayEvents(events) {
        const container = document.getElementById('eventsContainer');
        container.innerHTML = '';

        if (events.length === 0) {
            container.innerHTML = `
            <div class="card text-center">
                <h3>No Events Available</h3>
                <p>There are no events scheduled at the moment</p>
            </div>
        `;
            return;
        }

        events.forEach(event => {
            const eventCard = document.createElement('div');
            eventCard.className = 'card';
            eventCard.innerHTML = `
            <h3>${event.title}</h3>
            <p><strong>Description:</strong> ${event.description || 'No description available'}</p>
            <p><strong>Venue:</strong> ${event.venue || 'Not specified'}</p>
            <p><strong>Date:</strong> ${new Date(event.starts_at).toLocaleDateString('en-US')}</p>
            <p><strong>Time:</strong> ${new Date(event.starts_at).toLocaleTimeString('en-US')}</p>
            <p><strong>Available Seats:</strong> ${event.total_seats}</p>
            <button class="btn" onclick="showSeatPicker(${event.id}, '${event.title}', ${event.total_seats})">
                View Seats
            </button>
        `;
            container.appendChild(eventCard);
        });
    }

    function showSeatPicker(eventId, eventTitle, totalSeats) {
        currentEvent = { id: eventId, title: eventTitle, totalSeats };
        document.getElementById('eventTitle').textContent = `Select Seat - ${eventTitle}`;

        // Generate seat grid
        const seatGrid = document.getElementById('seatGrid');
        seatGrid.innerHTML = '';

        for (let i = 1; i <= totalSeats; i++) {
            const seat = document.createElement('div');
            seat.className = 'seat available';
            seat.textContent = i;
            seat.onclick = () => selectSeat(i, seat);
            seatGrid.appendChild(seat);
        }

        showModal('seatModal');
    }

    function selectSeat(seatNumber, seatElement) {
        // Remove previous selection
        document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));

        // Select new seat
        seatElement.classList.add('selected');
        selectedSeat = seatNumber;
        document.getElementById('selectedSeat').textContent = seatNumber;
        document.getElementById('confirmBtn').disabled = false;
    }

    async function confirmBooking() {
        if (!selectedSeat || !currentEvent) return;

        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showAlert('Please login first', 'error');
                return;
            }

            const response = await fetch(`/api/events/${currentEvent.id}/bookings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    seat_number: selectedSeat
                })
            });

            if (response.ok) {
                const booking = await response.json();
                showBookingSuccess(booking);
                hideModal('seatModal');
            } else {
                const errorData = await response.json();
                showAlert(errorData.detail || 'Booking failed', 'error');
            }
        } catch (error) {
            showAlert('Connection error occurred', 'error');
        }
    }

    function showBookingSuccess(booking) {
        document.getElementById('bookedSeat').textContent = selectedSeat;
        document.getElementById('bookedEvent').textContent = currentEvent.title;

        // Generate QR code (you can use a QR library here)
        const qrContainer = document.getElementById('qrCode');
        qrContainer.innerHTML = `
        <div style="width: 200px; height: 200px; background: #f0f0f0; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px solid #000;">
            <i class="fas fa-qrcode" style="font-size: 100px; color: #000;"></i>
        </div>
    `;

        showModal('qrModal');
    }

    function downloadTicket() {
        // Implement ticket download functionality
        showAlert('Ticket download will be available soon', 'success');
    }

    function sendEmail() {
        // Implement email sending functionality
        showAlert('Email will be sent soon', 'success');
    }
</script>
{% endblock %}