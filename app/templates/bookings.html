{% extends "base.html" %}

{% block title %}My Bookings{% endblock %}

{% block content %}
<div class="text-center mb-3">
    <h1>My Bookings</h1>
    <p>View and manage all your bookings</p>
</div>

<div class="grid grid-2" id="bookingsContainer">
    <!-- Bookings will be loaded here -->
</div>

<!-- QR Code Modal -->
<div id="qrModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('qrModal')">&times;</span>
        <h2>Ticket QR Code</h2>

        <div class="text-center">
            <div id="qrCode"></div>
            <p class="mt-2">Seat Number: <span id="qrSeat"></span></p>
            <p>Event: <span id="qrEvent"></span></p>
            <p>Booking Date: <span id="qrDate"></span></p>

            <div class="mt-3">
                <button class="btn" onclick="downloadQR()">Download QR</button>
                <button class="btn btn-secondary" onclick="hideModal('qrModal')">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load bookings on page load
    document.addEventListener('DOMContentLoaded', loadBookings);

    async function loadBookings() {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showAlert('Please login first', 'error');
                return;
            }

            const response = await fetch('/api/bookings', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const bookings = await response.json();
                displayBookings(bookings);
            } else {
                showAlert('Failed to load bookings', 'error');
            }
        } catch (error) {
            showAlert('Connection error occurred', 'error');
        }
    }

    function displayBookings(bookings) {
        const container = document.getElementById('bookingsContainer');
        container.innerHTML = '';

        if (bookings.length === 0) {
            container.innerHTML = `
            <div class="card text-center">
                <h3>No Bookings Found</h3>
                <p>You haven't booked any events yet</p>
                <a href="/events" class="btn">Browse Events</a>
            </div>
        `;
            return;
        }

        bookings.forEach(booking => {
            const bookingCard = document.createElement('div');
            bookingCard.className = 'card';

            const statusClass = getStatusClass(booking.status);
            const statusText = getStatusText(booking.status);

            bookingCard.innerHTML = `
            <h3>${booking.event.title}</h3>
            <p><strong>Seat Number:</strong> ${booking.seat_number}</p>
            <p><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></p>
            <p><strong>Booking Date:</strong> ${new Date(booking.created_at).toLocaleDateString('en-US')}</p>
            <p><strong>Event Date:</strong> ${new Date(booking.event.starts_at).toLocaleDateString('en-US')}</p>
            
            <div class="mt-2">
                <button class="btn" onclick="showQR(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                    Show QR
                </button>
                ${booking.status === 'CONFIRMED' ? `
                    <button class="btn btn-secondary" onclick="cancelBooking(${booking.id})">
                        Cancel Booking
                    </button>
                ` : ''}
            </div>
        `;
            container.appendChild(bookingCard);
        });
    }

    function getStatusClass(status) {
        switch (status) {
            case 'CONFIRMED': return 'alert-success';
            case 'CANCELLED': return 'alert-error';
            default: return '';
        }
    }

    function getStatusText(status) {
        switch (status) {
            case 'CONFIRMED': return 'Confirmed';
            case 'CANCELLED': return 'Cancelled';
            default: return status;
        }
    }

    function showQR(booking) {
        document.getElementById('qrSeat').textContent = booking.seat_number;
        document.getElementById('qrEvent').textContent = booking.event.title;
        document.getElementById('qrDate').textContent = new Date(booking.created_at).toLocaleDateString('en-US');

        // Generate QR code (you can use a QR library here)
        const qrContainer = document.getElementById('qrCode');
        qrContainer.innerHTML = `
        <div style="width: 200px; height: 200px; background: #f0f0f0; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px solid #000;">
            <i class="fas fa-qrcode" style="font-size: 100px; color: #000;"></i>
        </div>
    `;

        showModal('qrModal');
    }

    async function cancelBooking(bookingId) {
        if (!confirm('Are you sure you want to cancel this booking?')) return;

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                showAlert('Booking cancelled successfully', 'success');
                loadBookings(); // Reload bookings
            } else {
                const errorData = await response.json();
                showAlert(errorData.detail || 'Failed to cancel booking', 'error');
            }
        } catch (error) {
            showAlert('Connection error occurred', 'error');
        }
    }

    function downloadQR() {
        // Implement QR download functionality
        showAlert('QR download will be available soon', 'success');
    }
</script>
{% endblock %}