{% extends "base.html" %}

{% block title %}Ticket Scanner{% endblock %}

{% block content %}
<div class="text-center mb-3">
    <h1>Ticket Scanner</h1>
    <p>Scan QR codes to verify ticket validity</p>
</div>

<div class="card" style="max-width: 600px; margin: 0 auto;">
    <div class="text-center mb-3">
        <button class="btn" onclick="startCamera()" id="startBtn">
            <i class="fas fa-camera"></i> Start Camera
        </button>
        <button class="btn btn-secondary" onclick="stopCamera()" id="stopBtn" style="display: none;">
            <i class="fas fa-stop"></i> Stop Camera
        </button>
    </div>
    
    <div id="cameraContainer" style="display: none;">
        <video id="video" width="100%" autoplay></video>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>
    
    <div class="text-center mt-3">
        <p>Or enter ticket code manually:</p>
        <div class="form-group">
            <input type="text" id="manualToken" class="form-input" placeholder="Enter ticket code">
            <button class="btn mt-2" onclick="verifyManualToken()">Verify</button>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div id="resultModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideModal('resultModal')">&times;</span>
        <div id="resultContent">
            <!-- Result will be displayed here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let stream = null;
let scanning = false;

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        document.getElementById('cameraContainer').style.display = 'block';
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        
        scanning = true;
        scanQR();
        
    } catch (error) {
        showAlert('Failed to start camera', 'error');
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    document.getElementById('cameraContainer').style.display = 'none';
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    
    scanning = false;
}

function scanQR() {
    if (!scanning) return;
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    // Here you would implement QR code detection
    // For now, we'll simulate it with a timeout
    setTimeout(() => {
        if (scanning) {
            // Simulate QR detection
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0aWNrZXQiLCJib29raW5nX2lkIjoxLCJldmVudF9pZCI6MiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiZXhwIjoxNzg4NDQ5MDM5fQ.example';
            verifyToken(mockToken);
        }
    }, 2000);
}

async function verifyManualToken() {
    const token = document.getElementById('manualToken').value.trim();
    if (!token) {
        showAlert('Please enter a ticket code', 'error');
        return;
    }
    
    await verifyToken(token);
}

async function verifyToken(token) {
    try {
        const response = await fetch(`/tickets/verify?token=${encodeURIComponent(token)}`);
        
        if (response.ok) {
            const result = await response.json();
            showResult(result, true);
        } else {
            const errorData = await response.json();
            showResult({ detail: errorData.detail }, false);
        }
    } catch (error) {
        showResult({ detail: 'Connection error occurred' }, false);
    }
}

function showResult(result, success) {
    const resultContent = document.getElementById('resultContent');
    
    if (success) {
        resultContent.innerHTML = `
            <div class="text-center">
                <div style="width: 80px; height: 80px; background: #4caf50; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
                </div>
                <h2 style="color: #4caf50;">Valid Ticket</h2>
                <div class="card mt-3">
                    <p><strong>Booking ID:</strong> ${result.booking_id}</p>
                    <p><strong>Event ID:</strong> ${result.event_id}</p>
                    <p><strong>Email:</strong> ${result.email}</p>
                </div>
                <button class="btn mt-3" onclick="hideModal('resultModal')">Close</button>
            </div>
        `;
    } else {
        resultContent.innerHTML = `
            <div class="text-center">
                <div style="width: 80px; height: 80px; background: #f44336; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times" style="font-size: 40px; color: white;"></i>
                </div>
                <h2 style="color: #f44336;">Invalid Ticket</h2>
                <p class="mt-3">${result.detail}</p>
                <button class="btn mt-3" onclick="hideModal('resultModal')">Close</button>
            </div>
        `;
    }
    
    showModal('resultModal');
}

// Clean up when page is unloaded
window.addEventListener('beforeunload', () => {
    stopCamera();
});
</script>
{% endblock %}